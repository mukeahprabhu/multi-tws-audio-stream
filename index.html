<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Multi-TWS Audio Receiver</title>
</head>
<body>
  <h1>ðŸ”Š Multi-TWS Audio Receiver</h1>
  <button id="playButton">Start Audio Stream</button>

  <script>
    let audioElement;
    let mediaSource;
    let sourceBuffer;
    let ws;

    document.getElementById("playButton").addEventListener("click", () => {
      audioElement = document.createElement("audio");
      audioElement.controls = true;
      document.body.appendChild(audioElement);

      mediaSource = new MediaSource();
      audioElement.src = URL.createObjectURL(mediaSource);

      mediaSource.addEventListener("sourceopen", () => {
        try {
          sourceBuffer = mediaSource.addSourceBuffer("audio/mpeg");
          sourceBuffer.mode = "sequence";

          ws = new WebSocket("wss://multi-tws-audio-backend.onrender.com");
          ws.binaryType = "arraybuffer";

          ws.onopen = () => console.log("âœ… Client connected to WebSocket");

          ws.onmessage = (event) => {
            if (sourceBuffer && !sourceBuffer.updating) {
              try {
                sourceBuffer.appendBuffer(new Uint8Array(event.data));
              } catch (err) {
                console.error("ðŸš« Error appending buffer:", err);
              }
            }
          };

          ws.onerror = (error) => console.error("âš ï¸ WebSocket error:", error);

          sourceBuffer.addEventListener("updateend", () => {
            const bufferLength = audioElement.buffered.length;
            const bufferedEnd = bufferLength ? audioElement.buffered.end(bufferLength - 1) : 0;
            const timeDiff = bufferedEnd - audioElement.currentTime;

            if (audioElement.paused && timeDiff > 0.5) {
              audioElement.play().catch(err => console.error("ðŸš« Error playing:", err));
            }

            if (timeDiff > 1.5) {
              audioElement.currentTime = bufferedEnd - 0.2;
            }
          });
        } catch (err) {
          console.error("âŒ MediaSource error:", err);
        }
      });

      audioElement.addEventListener("error", (e) => {
        console.error("ðŸŽµ Audio error:", e);
      });
    });
  </script>
</body>
</html>
