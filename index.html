<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Live Audio Streaming</title>
</head>
<body>
  <h2>Live Audio Streaming</h2>
  <p>Status: <span id="status">Connecting...</span></p>
  <audio id="audio" controls autoplay></audio>

  <script>
    const audio = document.getElementById("audio");
    const mediaSource = new MediaSource();
    audio.src = URL.createObjectURL(mediaSource);
    document.getElementById("status").innerText = "Initializing...";

    let sourceBuffer;
    let queue = [];

    mediaSource.addEventListener("sourceopen", () => {
      sourceBuffer = mediaSource.addSourceBuffer('audio/webm; codecs="vorbis"');

      sourceBuffer.addEventListener("updateend", () => {
        if (queue.length > 0 && !sourceBuffer.updating) {
          sourceBuffer.appendBuffer(queue.shift());
        }
      });

      connectWebSocket();
    });

    function connectWebSocket() {
      // Connect to the WebSocket server using ws:// for testing
      const ws = new WebSocket("ws://multi-tws-audio-backend.onrender.com:8080");  // Use ws:// for testing if wss:// fails
      ws.binaryType = "arraybuffer";

      ws.onopen = () => {
        document.getElementById("status").innerText = "Connected to WebSocket server";
        console.log("WebSocket connection opened.");
      };

      ws.onmessage = (event) => {
        console.log("Received audio data:", event.data);
        if (sourceBuffer.updating || queue.length > 0) {
          queue.push(event.data);  // Store audio data until buffer is ready
        } else {
          sourceBuffer.appendBuffer(event.data);  // Append audio data directly to buffer
        }
      };

      ws.onerror = (err) => {
        console.error("WebSocket error:", err);
        // Log error details
        if (err instanceof Event) {
          console.log("Error event details:", err);
        }
      };

      ws.onclose = (event) => {
        document.getElementById("status").innerText = "WebSocket Disconnected";
        console.log("WebSocket closed", event);
        // Provide more specific close reasons
        console.log("WebSocket close event details:", event);
      };
    }
  </script>
</body>
</html>
