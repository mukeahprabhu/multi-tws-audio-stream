<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Live Audio Streaming</title>
</head>
<body>
  <h2>Live Audio Streaming</h2>
  <p>Status: <span id="status">Connecting...</span></p>
  <audio id="audio" controls autoplay></audio>

  <script>
    const audio = document.getElementById("audio");
    const mediaSource = new MediaSource();
    audio.src = URL.createObjectURL(mediaSource);
    document.getElementById("status").innerText = "Initializing...";

    let sourceBuffer;
    let queue = [];

    mediaSource.addEventListener("sourceopen", () => {
      sourceBuffer = mediaSource.addSourceBuffer('audio/webm; codecs="vorbis"');

      sourceBuffer.addEventListener("updateend", () => {
        if (queue.length > 0 && !sourceBuffer.updating) {
          sourceBuffer.appendBuffer(queue.shift());
        }
      });

      connectWebSocket();
    });

    function connectWebSocket() {
      const wsProtocol = location.protocol === "https:" ? "wss" : "ws";
      const wsHost = location.host || "localhost:10000"; // fallback for local testing
      const ws = new WebSocket(`${wsProtocol}://${wsHost}`);
      ws.binaryType = "arraybuffer";

      ws.onopen = () => {
        document.getElementById("status").innerText = "Connected";
        console.log("WebSocket connected");
      };

      ws.onmessage = (event) => {
        if (sourceBuffer.updating || queue.length > 0) {
          queue.push(event.data);
        } else {
          sourceBuffer.appendBuffer(event.data);
        }
      };

      ws.onerror = (error) => {
        console.error("WebSocket error:", error);
        document.getElementById("status").innerText = "Error";
      };

      ws.onclose = () => {
        console.log("WebSocket closed");
        document.getElementById("status").innerText = "Disconnected";
      };
    }
  </script>
</body>
</html>
